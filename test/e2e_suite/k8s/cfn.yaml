apiVersion: cloudformation.linki.space/v1alpha1
kind: Stack
metadata:
  name: "{{.Var.FullName | len}}"
spec:
  template: |
    Conditions:
      CoreCluster:
        Fn::Equals:
          - "{{.Var.Cluster}}"
          - core
    Mappings:
      Environment2Capacity:
        local:
          Read: 1
          Write: 1
        sandbox:
          Read: 1
          Write: 1
        dev:
          Read: 1
          Write: 1
        qa:
          Read: 1
          Write: 1
        prod:
          Read: 2
          Write: 2
    Resources:
      ddbTable:
        Type: AWS::DynamoDB::Table
        Condition: CoreCluster
        Properties:
          TableName: "{{.Var.Environment}}-{{.Pkg.Name}}"
          AttributeDefinitions:
            - AttributeName: Kind
              AttributeType: S
            - AttributeName: Name
              AttributeType: S
          KeySchema:
            - AttributeName: Kind
              KeyType: HASH
            - AttributeName: Name
              KeyType: RANGE
          ProvisionedThroughput:
            ReadCapacityUnits: {"Fn::FindInMap": [ "Environment2Capacity", "{{.Var.Environment}}", "Read" ]}
            WriteCapacityUnits: {"Fn::FindInMap": [ "Environment2Capacity", "{{.Var.Environment}}", "Write" ]}
      iamRole:
        Type: AWS::IAM::Role
        Properties:
          Path: /
          RoleName: "{{.Var.FullName}}"
          AssumeRolePolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Principal:
                  Service:
                    - ec2.amazonaws.com
                Action: sts:AssumeRole
              - {{.Var.AWSKubeAssumeRolePolicy}}
          Policies:
            - PolicyName: dynamodb_data
              PolicyDocument:
                Version: '2012-10-17'
                Statement:
                  - Effect: "Allow"
                    Action:
                      - "dynamodb:BatchGetItem"
                      - "dynamodb:DeleteItem"
                      - "dynamodb:GetItem"
                      - "dynamodb:PutItem"
                      - "dynamodb:Query"
                      - "dynamodb:Scan"
                      - "dynamodb:UpdateItem"
                    Resource:
                      Fn::Join:
                        - ":"
                        - - "arn:aws:dynamodb"
                          - {{if (or (eq .Var.Environment "sandbox") (eq .Var.Environment "local"))}}"eu-west-1"{{else}}"eu-central-1"{{end}}
                          - "Ref" : "AWS::AccountId"
                          - "table/{{.Var.Environment}}-{{.Pkg.Name}}"
            - PolicyName: sns_topic_managemnet
              PolicyDocument:
                Version: '2012-10-17'
                Statement:
                  - Effect: "Allow"
                    Action:
                      - "sns:CreateTopic"
                      - "sns:DeleteTopic"
                      - "sns:GetTopicAttributes"
                      - "sns:SetTopicAttributes"
                      - "sns:AddPermission"
                      - "sns:RemovePermission"
                    Resource:
                      Fn::Join:
                        - ":"
                        - - "arn:aws:sns"
                          - "Ref" : "AWS::Region"
                          - "Ref" : "AWS::AccountId"
                          - "*"
            - PolicyName: sns_subscribe
              PolicyDocument:
                Version: '2012-10-17'
                Statement:
                  - Effect: "Allow"
                    Action:
                      - "sns:ListSubscriptionsByTopic"
                      - "sns:Subscribe"
                      - "sns:Unsubscribe"
                    Resource: "*"
            - PolicyName: sqs_queue_managemnet
              PolicyDocument:
                Version: '2012-10-17'
                Statement:
                  - Effect: "Allow"
                    Action:
                      - "sqs:CreateQueue"
                      - "sqs:DeleteQueue"
                      - "sqs:GetQueueAttributes"
                      - "sqs:SetQueueAttributes"
                      - "sqs:GetQueueUrl"
                      - "sqs:AddPermission"
                      - "sqs:RemovePermission"
                    Resource:
                      Fn::Join:
                        - ":"
                        - - "arn:aws:sqs"
                          - "Ref" : "AWS::Region"
                          - "Ref" : "AWS::AccountId"
                          - "*"
            - PolicyName: sqs_subscribe
              PolicyDocument:
                Version: '2012-10-17'
                Statement:
                  - Effect: "Allow"
                    Action:
                      - "sqs:GetQueueAttributes"
                      - "sqs:SetQueueAttributes"
                      - "sqs:GetQueueUrl"
                      - "sqs:AddPermission"
                      - "sqs:RemovePermission"
                    Resource: "*"
